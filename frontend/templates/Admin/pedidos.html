{% extends "Admin/base.html" %}

{% block title %}Pedidos - CupcakeStore{% endblock %}

{% block content %}
<!-- üëá ESTAT√çSTICAS -->
<div class="estatisticas">
    {% for stat in contagem_status %}
    <div class="estatistica-card">
        <h3>{{ stat['status']|title }}</h3>
        <div class="estatistica-numero">{{ stat['count'] }}</div>
        <small>Pedidos</small>
    </div>
    {% endfor %}
    <div class="estatistica-card">
        <h3>Total</h3>
        <div class="estatistica-numero">{{ pedidos|length }}</div>
        <small>Pedidos</small>
    </div>
</div>

<!-- üëá FILTROS -->
<div class="filtros-pedidos">
    <div class="filtro-status">
        <button class="btn-status todos {% if status_filter == 'todos' %}ativo{% endif %}" onclick="filtrarPorStatus('todos')">
            üì¶ Todos
        </button>
        <button class="btn-status pendente {% if status_filter == 'pendente' %}ativo{% endif %}" onclick="filtrarPorStatus('pendente')">
            ‚è≥ Pendentes
        </button>
        <button class="btn-status processando {% if status_filter == 'processando' %}ativo{% endif %}" onclick="filtrarPorStatus('processando')">
            üßë‚Äçüç≥ Processando
        </button>
        <button class="btn-status enviado {% if status_filter == 'enviado' %}ativo{% endif %}" onclick="filtrarPorStatus('enviado')">
            üöö Enviados
        </button>
        <button class="btn-status entregue {% if status_filter == 'entregue' %}ativo{% endif %}" onclick="filtrarPorStatus('entregue')">
            ‚úÖ Entregues
        </button>
        <button class="btn-status cancelado {% if status_filter == 'cancelado' %}ativo{% endif %}" onclick="filtrarPorStatus('cancelado')">
            ‚ùå Cancelados
        </button>
        <button class="btn-status reset-numeracao" onclick="abrirModalResetNumeracao()">
            üîÑ Resetar Numera√ß√£o
        </button>
        <button class="btn-status excluir-todos" onclick="abrirModalExcluirTodos()" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
            üóëÔ∏è Excluir Todos
        </button>
    </div>
</div>

<!-- üëá LISTA DE PEDIDOS -->
<div class="pedidos-grid">
    {% if pedidos %}
    {% for pedido in pedidos %}
    <div class="pedido-card {{ pedido['status'] }}">
        <div class="pedido-header">
            <div class="pedido-info">
                <h3>Pedido #{{ pedido['id'] }}</h3>
                <p><strong>Cliente:</strong> {{ pedido['username'] }}</p>
                <p><strong>Data:</strong> {{ pedido['created_at'] }}</p>
                <p><strong>Total:</strong> R$ {{ "%.2f"|format(pedido['total_amount']) }}</p>
                <p><strong>Pagamento:</strong>
                    {% if pedido['metodo_pagamento'] == 'dinheiro' %}üíµ Dinheiro{% endif %}
                    {% if pedido['metodo_pagamento'] == 'cartao' %}üí≥ Cart√£o{% endif %}
                    {% if pedido['metodo_pagamento'] == 'pix' %}üì± PIX{% endif %}
                    {% if not pedido['metodo_pagamento'] %}üí≥ Cart√£o (padr√£o){% endif %}
                </p>
            </div>
            <span class="pedido-status status-{{ pedido['status'] }}">
                {{ pedido['status']|title }}
            </span>
        </div>

        <div class="pedido-itens">
            <strong>Itens do Pedido:</strong>
            {% if pedido.order_data %}
                {% set order_data = pedido.order_data %}
                {% if order_data is string %}
                    {% set order_data = order_data|parse_json %}
                {% endif %}
                
                {% if order_data.itens is defined %}
                    {% for item in order_data.itens %}
                        <div class="item-pedido">
                            <span>{{ item.quantidade }}x {{ item.nome }}</span>
                            <span>R$ {{ "%.2f"|format(item.preco * item.quantidade) }}</span>
                        </div>
                    {% endfor %}
                {% else %}
                    {% for item in order_data %}
                        <div class="item-pedido">
                            <span>
                                {% if item.quantidade %}{{ item.quantidade }}x {% endif %}
                                {{ item.nome if item.nome else 'Item' }}
                            </span>
                            <span>
                                R$ 
                                {% if item.preco and item.quantidade %}
                                    {{ "%.2f"|format(item.preco * item.quantidade) }}
                                {% elif item.preco %}
                                    {{ "%.2f"|format(item.preco) }}
                                {% else %}
                                    0.00
                                {% endif %}
                            </span>
                        </div>
                    {% endfor %}
                {% endif %}
            {% else %}
                <p>Nenhum item dispon√≠vel</p>
            {% endif %}
        </div>

        <div class="pedido-acoes">
            <select class="select-status" id="status-{{ pedido['id'] }}">
                <option value="pendente" {% if pedido['status']=='pendente' %}selected{% endif %}>‚è≥ Pendente</option>
                <option value="processando" {% if pedido['status']=='processando' %}selected{% endif %}>üßë‚Äçüç≥ Processando</option>
                <option value="enviado" {% if pedido['status']=='enviado' %}selected{% endif %}>üöö Enviado</option>
                <option value="entregue" {% if pedido['status']=='entregue' %}selected{% endif %}>‚úÖ Entregue</option>
                <option value="cancelado" {% if pedido['status']=='cancelado' %}selected{% endif %}>‚ùå Cancelado</option>
            </select>
            <button class="btn-atualizar" onclick="atualizarStatus({{ pedido['id'] }})">
                üíæ Atualizar
            </button>
            <button class="btn-excluir-pedido" onclick="abrirModalExclusaoPedido({{ pedido['id'] }}, {{ pedido['total_amount'] }})">
                üóëÔ∏è Excluir
            </button>
        </div>
    </div>
    {% endfor %}
    {% else %}
    <div class="nenhum-pedido">
        <h2>üì¶ Nenhum pedido encontrado</h2>
        <p>N√£o h√° pedidos con o status selecionado.</p>
        <button class="btn-status todos" onclick="filtrarPorStatus('todos')">
            Ver Todos os Pedidos
        </button>
    </div>
    {% endif %}
</div>

<!-- üëá MODAL DE CONFIRMA√á√ÉO PARA EXCLUS√ÉO DE PEDIDOS -->
<div id="modalExclusaoPedido" class="modal-confirmacao">
    <div class="modal-confirmacao-conteudo">
        <div class="modal-confirmacao-cabecalho">
            <h3>üì¶ Confirmar Exclus√£o de Pedido</h3>
            <span class="modal-confirmacao-fechar" onclick="fecharModalPedido()">&times;</span>
        </div>
        <div class="modal-confirmacao-corpo">
            <p>Tem certeza que deseja excluir o pedido <strong id="id-pedido-excluir">#000</strong>?</p>
            <p>Valor total: <strong id="valor-pedido-excluir">R$ 0,00</strong></p>
            <p>‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita!</p>
        </div>
        <div class="modal-confirmacao-rodape">
            <button class="btn-modal btn-modal-cancelar" onclick="fecharModalPedido()">‚ùå Cancelar</button>
            <button class="btn-modal btn-modal-confirmar" onclick="confirmarExclusaoPedido()">üóëÔ∏è Sim, Excluir</button>
        </div>
    </div>
</div>

<!-- üëá MODAL DE CONFIRMA√á√ÉO PARA RESET DE NUMERA√á√ÉO -->
<div id="modalResetNumeracao" class="modal-confirmacao">
    <div class="modal-confirmacao-conteudo">
        <div class="modal-confirmacao-cabecalho">
            <h3>üîÑ Resetar Numera√ß√£o de Pedidos</h3>
            <span class="modal-confirmacao-fechar" onclick="fecharModalResetNumeracao()">&times;</span>
        </div>
        <div class="modal-confirmacao-corpo">
            <p>Tem certeza que deseja resetar a numera√ß√£o dos pedidos?</p>
            <p>üìù <strong>Pr√≥ximo pedido come√ßar√° do n√∫mero sequencial correto.</strong></p>
            <p>‚ö†Ô∏è Esta a√ß√£o n√£o afeta os pedidos existentes, apenas a numera√ß√£o futura.</p>
        </div>
        <div class="modal-confirmacao-rodape">
            <button class="btn-modal btn-modal-cancelar" onclick="fecharModalResetNumeracao()">‚ùå Cancelar</button>
            <button class="btn-modal btn-modal-confirmar" onclick="confirmarResetNumeracao()">üîÑ Sim, Resetar</button>
        </div>
    </div>
</div>

<!-- üëá MODAL DE CONFIRMA√á√ÉO PARA EXCLUS√ÉO DE TODOS OS PEDIDOS -->
<div id="modalExcluirTodos" class="modal-confirmacao">
    <div class="modal-confirmacao-conteudo">
        <div class="modal-confirmacao-cabecalho">
            <h3>üóëÔ∏è Confirmar Exclus√£o Total</h3>
            <span class="modal-confirmacao-fechar" onclick="fecharModalExcluirTodos()">&times;</span>
        </div>
        <div class="modal-confirmacao-corpo">
            <p>Tem certeza que deseja excluir <strong>TODOS</strong> os pedidos do sistema?</p>
            <p>‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita e remover√° todos os registros de pedidos!</p>
            <p>üìä Total de pedidos: <strong id="total-pedidos-excluir">0</strong></p>
        </div>
        <div class="modal-confirmacao-rodape">
            <button class="btn-modal btn-modal-cancelar" onclick="fecharModalExcluirTodos()">‚ùå Cancelar</button>
            <button class="btn-modal btn-modal-confirmar" onclick="confirmarExclusaoTodos()">üóëÔ∏è Sim, Excluir Tudo</button>
        </div>
    </div>
</div>

<script>
    // üëá VARI√ÅVEIS GLOBAIS PARA EXCLUS√ÉO DE PEDIDOS
    let pedidoIdParaExcluir = null;
    let pedidoValorParaExcluir = null;

    // üëá FILTRAR POR STATUS
    function filtrarPorStatus(status) {
        window.location.href = `/admin/pedidos?status=${status}`;
    }

    // üëá ATUALIZAR STATUS
    function atualizarStatus(pedidoId) {
        const select = document.getElementById(`status-${pedidoId}`);
        const novoStatus = select.value;
        const statusAnterior = select.getAttribute('data-status-anterior');

        // Se n√£o mudou, n√£o faz nada
        if (novoStatus === statusAnterior) {
            return;
        }

        fetch(`/admin/pedido/${pedidoId}/status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ status: novoStatus })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.redirect) {
                    // Redireciona para a mesma p√°gina para mostrar a flash message
                    const urlParams = new URLSearchParams(window.location.search);
                    const statusFilter = urlParams.get('status') || 'todos';
                    window.location.href = `/admin/pedidos?status=${statusFilter}`;
                } else if (!data.success && data.redirect) {
                    // Tamb√©m redireciona para mostrar mensagem de erro
                    const urlParams = new URLSearchParams(window.location.search);
                    const statusFilter = urlParams.get('status') || 'todos';
                    window.location.href = `/admin/pedidos?status=${statusFilter}`;
                } else if (!data.success) {
                    alert('Erro ao atualizar status: ' + (data.message || 'Erro desconhecido'));
                    // Reverte o select para o status anterior
                    select.value = statusAnterior;
                }
            })
            .catch(error => {
                alert('Erro de conex√£o ao atualizar status');
                select.value = statusAnterior;
            });
    }

    // üëá ABRIR MODAL DE EXCLUS√ÉO DE PEDIDO
    function abrirModalExclusaoPedido(id, valor) {
        pedidoIdParaExcluir = id;
        pedidoValorParaExcluir = valor;

        document.getElementById('id-pedido-excluir').textContent = '#' + id;
        document.getElementById('valor-pedido-excluir').textContent = 'R$ ' + valor.toFixed(2);
        document.getElementById('modalExclusaoPedido').style.display = 'block';
    }

    // üëá FECHAR MODAL DE PEDIDO
    function fecharModalPedido() {
        document.getElementById('modalExclusaoPedido').style.display = 'none';
        pedidoIdParaExcluir = null;
        pedidoValorParaExcluir = null;
    }

    // üëá CONFIRMAR EXCLUS√ÉO DE PEDIDO
    function confirmarExclusaoPedido() {
        if (pedidoIdParaExcluir) {
            fetch(`/admin/pedido/${pedidoIdParaExcluir}/excluir`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // üî• REDIRECIONA PARA A MESMA P√ÅGINA PARA MOSTRAR A MENSAGEM FLASH
                        window.location.href = '/admin/pedidos?status=' + (new URLSearchParams(window.location.search).get('status') || 'todos');
                    } else {
                        // Mostra alerta tempor√°rio se der erro
                        alert('Erro: ' + data.message);
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    location.reload();
                });
        }
        fecharModalPedido();
    }

    // üëá FUN√á√ïES PARA RESET DE NUMERA√á√ÉO
    function abrirModalResetNumeracao() {
        document.getElementById('modalResetNumeracao').style.display = 'block';
    }

    function fecharModalResetNumeracao() {
        document.getElementById('modalResetNumeracao').style.display = 'none';
    }

    function confirmarResetNumeracao() {
        fetch('/admin/pedidos/resetar-numeracao', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Fecha o modal e recarrega a p√°gina para ver a mensagem flash
                    fecharModalResetNumeracao();
                    window.location.href = '/admin/pedidos?status=' + (new URLSearchParams(window.location.search).get('status') || 'todos');
                } else {
                    alert('Erro: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao resetar numera√ß√£o');
            });
    }

    // üëá FUN√á√ïES PARA EXCLUS√ÉO DE TODOS OS PEDIDOS
    function abrirModalExcluirTodos() {
        document.getElementById('modalExcluirTodos').style.display = 'block';
    }

    function fecharModalExcluirTodos() {
        document.getElementById('modalExcluirTodos').style.display = 'none';
    }

    function confirmarExclusaoTodos() {
        fetch('/admin/pedidos/excluir-todos', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Recarrega a p√°gina para mostrar a mensagem de sucesso
                    window.location.href = '/admin/pedidos?status=todos';
                } else {
                    alert('Erro: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao excluir todos os pedidos');
            });
        
        fecharModalExcluirTodos();
    }

    // üëá FECHAR MODAL AO CLICAR FORA
    document.getElementById('modalExclusaoPedido').addEventListener('click', function(e) {
        if (e.target === this) {
            fecharModalPedido();
        }
    });

    document.getElementById('modalResetNumeracao').addEventListener('click', function(e) {
        if (e.target === this) {
            fecharModalResetNumeracao();
        }
    });

    document.getElementById('modalExcluirTodos').addEventListener('click', function(e) {
        if (e.target === this) {
            fecharModalExcluirTodos();
        }
    });
</script>

<style>
    .estatisticas {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }

    .estatistica-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        text-align: center;
    }

    .estatistica-numero {
        font-size: 2em;
        font-weight: bold;
        margin: 10px 0;
    }

    .filtros-pedidos {
        margin-bottom: 25px;
    }

    .filtro-status {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .btn-status {
        padding: 10px 20px;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
    }

    .btn-status.todos {
        background: linear-gradient(135deg, #ff6b8b, #ff4d73);
        color: white;
    }

    .btn-status.todos:hover {
        background: linear-gradient(135deg, #ff4d73, #ff3366);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 107, 139, 0.4);
    }

    .btn-status.pendente {
        background: linear-gradient(135deg, #ffeaa7, #fab1a0);
        color: #d63031;
    }

    .btn-status.processando {
        background: linear-gradient(135deg, #81ecec, #74b9ff);
        color: #2d3436;
    }

    .btn-status.enviado {
        background: linear-gradient(135deg, #a29bfe, #6c5ce7);
        color: white;
    }

    .btn-status.entregue {
        background: linear-gradient(135deg, #00b894, #00a085);
        color: white;
    }

    .btn-status.cancelado {
        background: linear-gradient(135deg, #636e72, #2d3436);
        color: white;
    }

    .btn-status.reset-numeracao {
        background: linear-gradient(135deg, #9b59b6, #8e44ad);
        color: white;
    }

    .btn-status.excluir-todos {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
    }

    .btn-status:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .btn-status.ativo {
        transform: scale(1.05);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .pedidos-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
    }

    .pedido-card {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border-left: 5px solid;
    }

    .pedido-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .pedido-card.pendente {
        border-left-color: #fdcb6e;
    }

    .pedido-card.processando {
        border-left-color: #74b9ff;
    }

    .pedido-card.enviado {
        border-left-color: #6c5ce7;
    }

    .pedido-card.entregue {
        border-left-color: #00b894;
    }

    .pedido-card.cancelado {
        border-left-color: #636e72;
    }

    .pedido-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
    }

    .pedido-info h3 {
        color: #ff6b8b;
        margin: 0 0 5px 0;
    }

    .pedido-status {
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 0.9em;
    }

    .status-pendente {
        background: #fff3cd;
        color: #856404;
    }

    .status-processando {
        background: #cce7ff;
        color: #004085;
    }

    .status-enviado {
        background: #e0cffc;
        color: #4a3c7d;
    }

    .status-entregue {
        background: #d4edda;
        color: #155724;
    }

    .status-cancelado {
        background: #f8d7da;
        color: #721c24;
    }

    .pedido-detalhes {
        margin-bottom: 20px;
    }

    .pedido-itens {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px dashed #ddd;
    }

    .item-pedido {
        display: flex;
        justify-content: space-between;
        padding: 5px 0;
        font-size: 0.9em;
    }

    .pedido-acoes {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        align-items: center;
        flex-wrap: wrap;
    }

    .select-status {
        flex: 1;
        min-width: 150px;
        padding: 8px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
    }

    .btn-atualizar {
        background: linear-gradient(135deg, #ff6b8b, #ff4d73);
        color: white;
        padding: 8px 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
    }

    .btn-atualizar:hover {
        background: linear-gradient(135deg, #ff4d73, #ff3366);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 107, 139, 0.4);
    }

    .btn-excluir-pedido {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
        padding: 8px 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
    }

    .btn-excluir-pedido:hover {
        background: linear-gradient(135deg, #c0392b, #a93226);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
    }

    .nenhum-pedido {
        text-align: center;
        padding: 50px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    @media (max-width: 768px) {
        .pedidos-grid {
            grid-template-columns: 1fr;
        }

        .filtro-status {
            justify-content: center;
        }

        .btn-status {
            padding: 8px 15px;
            font-size: 14px;
        }

        .pedido-header {
            flex-direction: column;
            gap: 10px;
        }

        .pedido-acoes {
            flex-direction: column;
            align-items: stretch;
        }
        
        .select-status {
            min-width: 100%;
        }
    }
</style>
{% endblock %}