{% extends "Admin/base.html" %}

{% block title %}Usu√°rios - CupcakeStore{% endblock %}

{% block content %}
<div class="search-bar">
    <input type="text" placeholder="üîç Buscar usu√°rios..." id="searchInput">
    <button class="btn-admin btn-primary" onclick="filtrarUsuarios()">Buscar</button>
</div>

<div class="usuarios-list">
    <h2>üìã Todos os Usu√°rios ({{ usuarios|length }})</h2>
    
    {% if usuarios|length == 0 %}
    <div class="nenhum-resultado" style="text-align: center; padding: 40px; background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        <h3 style="color: #ff6b8b;">üë• Nenhum usu√°rio encontrado</h3>
        <p>N√£o h√° usu√°rios cadastrados no sistema.</p>
    </div>
    {% else %}
    <table class="usuarios-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Email</th>
                <th>Tipo</th>
                <th>Data Cadastro</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
            {% for usuario in usuarios %}
            <tr class="usuario-row">
                <td>{{ usuario['id'] }}</td>
                <td>{{ usuario['username'] }}</td>
                <td>{{ usuario['email'] }}</td>
                <td>
                    {% if usuario['email'] == 'saviosales@cupcakestore.com' %}
                    <span class="admin-badge badge-master">üëë Master</span>
                    {% elif usuario['is_admin'] == 1 %}
                    <span class="admin-badge badge-admin">Administrador</span>
                    {% else %}
                    <span class="admin-badge badge-user">Usu√°rio</span>
                    {% endif %}
                </td>
                <td>{{ usuario['created_at'] }}</td>
                <td>
                    <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                        {% if usuario['email'] == 'saviosales@cupcakestore.com' %}
                        <!-- CONTA MASTER - A√á√ïES BLOQUEADAS -->
                        <button class="btn-admin btn-secondary" disabled title="Conta master protegida">
                            üëë Protegido
                        </button>

                        {% else %}
                        <!-- USU√ÅRIOS NORMAIS -->
                        {% if usuario['is_admin'] == 1 %}
                        <button class="btn-admin btn-warning" onclick="toggleAdmin({{ usuario['id'] }}, 0)">
                            Remover Admin
                        </button>
                        {% else %}
                        <button class="btn-admin btn-success" onclick="toggleAdmin({{ usuario['id'] }}, 1)">
                            Tornar Admin
                        </button>
                        {% endif %}

                        <a href="{{ url_for('admin_editar_usuario', user_id=usuario['id']) }}" class="btn-admin btn-primary">
                            ‚úèÔ∏è Editar
                        </a>

                        {% if usuario['id'] != session['user_id'] %}
                        <button class="btn-admin btn-danger" onclick="abrirModalExclusaoUsuario({{ usuario['id'] }}, '{{ usuario['username'] }}')">
                            üóëÔ∏è Excluir
                        </button>
                        {% else %}
                        <button class="btn-admin btn-secondary" disabled title="N√£o pode excluir a si mesmo">
                            üö´ Excluir
                        </button>
                        {% endif %}
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}
</div>

<!-- üëá MODAL DE CONFIRMA√á√ÉO PARA EXCLUS√ÉO -->
<div id="modalExclusaoUsuario" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üë§ Confirmar Exclus√£o</h3>
            <span class="modal-close" onclick="fecharModalUsuario()">&times;</span>
        </div>
        <div class="modal-body">
            <p>Tem certeza que deseja excluir o usu√°rio <strong id="nome-usuario-excluir">[Username]</strong>?</p>
            <p>‚ö†Ô∏è Todos os pedidos deste usu√°rio tamb√©m ser√£o removidos!</p>
        </div>
        <div class="modal-footer">
            <button class="btn-admin btn-secondary" onclick="fecharModalUsuario()">‚ùå Cancelar</button>
            <button class="btn-admin btn-danger" onclick="confirmarExclusaoUsuario()">üóëÔ∏è Sim, Excluir</button>
        </div>
    </div>
</div>

<script>
    // üëá VARI√ÅVEIS GLOBAIS
    let usuarioIdParaExcluir = null;
    let usuarioNomeParaExcluir = null;

    // üëá FUN√á√ÉO PARA FILTRAR USU√ÅRIOS
    function filtrarUsuarios() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const rows = document.querySelectorAll('.usuario-row');

        rows.forEach(row => {
            const username = row.cells[1].textContent.toLowerCase();
            const email = row.cells[2].textContent.toLowerCase();

            if (username.includes(searchTerm) || email.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    // üëá ABRIR MODAL DE EXCLUS√ÉO
    function abrirModalExclusaoUsuario(id, username) {
        usuarioIdParaExcluir = id;
        usuarioNomeParaExcluir = username;

        document.getElementById('nome-usuario-excluir').textContent = username;
        document.getElementById('modalExclusaoUsuario').style.display = 'block';
    }

    // üëá FECHAR MODAL
    function fecharModalUsuario() {
        document.getElementById('modalExclusaoUsuario').style.display = 'none';
        usuarioIdParaExcluir = null;
        usuarioNomeParaExcluir = null;
    }

    // üëá CONFIRMAR EXCLUS√ÉO
    function confirmarExclusaoUsuario() {
        if (usuarioIdParaExcluir) {
            // Cria um formul√°rio tempor√°rio para enviar a requisi√ß√£o POST
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/admin/usuario/${usuarioIdParaExcluir}/excluir`;

            // Adiciona o formul√°rio √† p√°gina e envia
            document.body.appendChild(form);
            form.submit();
        }
        fecharModalUsuario();
    }

    // üëá TOGGLE ADMIN
    function toggleAdmin(userId, isAdmin) {
        fetch('/admin/usuario/' + userId + '/admin', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ is_admin: isAdmin })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Erro ao atualizar permiss√µes: ' + data.message);
                }
            })
            .catch(error => {
                alert('Erro ao atualizar permiss√µes');
                console.error('Error:', error);
            });
    }

    // üëá BUSCA EM TEMPO REAL
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchInput');

        if (searchInput) {
            let searchTimeout;

            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    filtrarUsuarios();
                }, 300);
            });
        }

        // Fechar modal ao clicar fora
        document.getElementById('modalExclusaoUsuario').addEventListener('click', function(e) {
            if (e.target === this) {
                fecharModalUsuario();
            }
        });
    });
</script>

<style>
    .search-bar {
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
    }

    .search-bar input {
        flex: 1;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
    }

    .usuarios-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .usuarios-table th,
    .usuarios-table td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }

    .usuarios-table th {
        background: linear-gradient(135deg, #ff6b8b, #ff4d73);
        color: white;
        font-weight: bold;
    }

    .usuarios-table tr:hover {
        background: #f8f9fa;
    }

    .admin-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: bold;
    }

    .badge-admin {
        background: #ff6b8b;
        color: white;
    }

    .badge-user {
        background: #3498db;
        color: white;
    }

    .badge-master {
        background: linear-gradient(135deg, #ff6b8b, #ff4d73);
        color: white;
        border: 2px solid gold;
    }

    .btn-warning {
        background: linear-gradient(135deg, #f39c12, #e67e22);
        color: white;
    }

    .btn-warning:hover {
        background: linear-gradient(135deg, #e67e22, #d35400);
    }

    /* Estilos para modais */
    .modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
    }

    .modal-content {
        background: white;
        margin: 10% auto;
        padding: 0;
        border-radius: 15px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
        background: linear-gradient(135deg, #ff6b8b, #ff4d73);
        color: white;
        padding: 20px;
        border-radius: 15px 15px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 1.4em;
    }

    .modal-close {
        font-size: 1.8em;
        cursor: pointer;
    }

    .modal-body {
        padding: 30px;
        text-align: center;
    }

    .modal-footer {
        padding: 20px;
        text-align: center;
        border-top: 1px solid #eee;
        display: flex;
        gap: 15px;
        justify-content: center;
    }

    @media (max-width: 768px) {
        .usuarios-table {
            font-size: 14px;
        }

        .admin-badge {
            padding: 4px 8px;
            font-size: 12px;
        }
    }
</style>
{% endblock %}