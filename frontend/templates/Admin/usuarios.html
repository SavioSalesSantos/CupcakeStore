{% extends "Admin/base.html" %}

{% block title %}Usuários - CupcakeStore{% endblock %}

{% block content %}
<div class="search-bar">
    <input type="text" placeholder="🔍 Buscar usuários..." id="searchInput">
    <button class="btn-admin btn-primary" onclick="filtrarUsuarios()">Buscar</button>
</div>

<div class="usuarios-list">
    <h2>📋 Todos os Usuários ({{ usuarios|length }})</h2>

    {% if usuarios|length == 0 %}
    <div class="nenhum-resultado"
        style="text-align: center; padding: 40px; background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        <h3 style="color: #ff6b8b;">👥 Nenhum usuário encontrado</h3>
        <p>Não há usuários cadastrados no sistema.</p>
    </div>
    {% else %}
    <table class="usuarios-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Email</th>
                <th>Tipo</th>
                <th>Endereço</th>
                <th>Data Cadastro</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for usuario in usuarios %}
            <tr class="usuario-row">
                <td>{{ usuario['id'] }}</td>
                <td>{{ usuario['username'] }}</td>
                <td>{{ usuario['email'] }}</td>
                <td>
                    {% if usuario['email'] == 'saviosales@cupcakestore.com' %}
                    <span class="admin-badge badge-master">
                        <i class="fas fa-crown"></i> Master
                    </span>
                    {% elif usuario['is_admin'] == 1 %}
                    <span class="admin-badge badge-admin">
                        <i class="fas fa-user-shield"></i> Administrador
                    </span>
                    {% else %}
                    <span class="admin-badge badge-user">
                        <i class="fas fa-user"></i> Usuário
                    </span>
                    {% endif %}
                </td>
                <td>
                    {% if usuario['cep'] and usuario['rua'] and usuario['numero'] %}
                    <span class="badge-completo" title="Endereço completo">
                        <i class="fas fa-check-circle"></i> Completo
                    </span>
                    {% else %}
                    <span class="badge-incompleto">
                        <i class="fas fa-times-circle"></i> Incompleto
                    </span>
                    {% endif %}
                </td>
                <td>{{ usuario['created_at'] }}</td>
                <td>
                    <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                        {% if usuario['email'] == 'saviosales@cupcakestore.com' %}
                        <!-- CONTA MASTER - AÇÕES BLOQUEADAS -->
                        <button class="btn-admin btn-primary" disabled title="Conta master protegida">
                            <i class="fas fa-shield-alt"></i> Protegido
                        </button>

                        {% else %}
                        <!-- USUÁRIOS NORMAIS -->
                        {% if usuario['is_admin'] == 1 %}
                        <button class="btn-admin btn-danger"
                            onclick="abrirModalToggleAdmin({{ usuario['id'] }}, '{{ usuario['username'] }}', 1)">
                            <i class="fas fa-user-times"></i> Remover Admin
                        </button>
                        {% else %}
                        <button class="btn-admin btn-success"
                            onclick="abrirModalToggleAdmin({{ usuario['id'] }}, '{{ usuario['username'] }}', 0)">
                            <i class="fas fa-user-shield"></i> Tornar Admin
                        </button>
                        {% endif %}

                        <a href="{{ url_for('admin_editar_usuario', user_id=usuario['id']) }}"
                            class="btn-admin btn-primary">
                            <i class="fas fa-edit"></i> Editar
                        </a>

                        {% if usuario['id'] != session['user_id'] %}
                        <button class="btn-admin btn-primary"
                            onclick="abrirModalExclusaoUsuario({{ usuario['id'] }}, '{{ usuario['username'] }}')">
                            <i class="fas fa-trash-alt"></i> Excluir
                        </button>
                        {% else %}
                        <button class="btn-admin btn-primary" disabled title="Não pode excluir a si mesmo">
                            <i class="fas fa-ban"></i> Excluir
                        </button>
                        {% endif %}
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}
</div>

<!-- 👇 MODAL DE CONFIRMAÇÃO PARA EXCLUSÃO DE USUÁRIO (PADRONIZADO) -->
<div id="modalExclusaoUsuario" class="modal-confirmacao">
    <div class="modal-confirmacao-conteudo">
        <div class="modal-confirmacao-cabecalho">
            <h3>👤 Confirmar Exclusão de Usuário</h3>
            <span class="modal-confirmacao-fechar" onclick="fecharModalUsuario()">&times;</span>
        </div>
        <div class="modal-confirmacao-corpo">
            <p>Tem certeza que deseja excluir o usuário <strong id="nome-usuario-excluir">[Username]</strong>?</p>
            <p>⚠️ Todos os pedidos deste usuário também serão removidos!</p>
            <p><strong>🚫 Esta ação não pode ser desfeita!<strong></p>
        </div>
        <div class="modal-confirmacao-rodape">
            <button class="btn-modal" onclick="fecharModalUsuario()">
                <i class="fas fa-times"></i> Cancelar
            </button>
            <button class="btn-modal" onclick="confirmarExclusaoUsuario()">
                <i class="fas fa-user-slash"></i> Sim, Excluir
            </button>
        </div>
    </div>
</div>

<!-- 👇 MODAL DE CONFIRMAÇÃO PARA TORNAR/REMOVER ADMIN -->
<div id="modalToggleAdmin" class="modal-confirmacao">
    <div class="modal-confirmacao-conteudo">
        <div class="modal-confirmacao-cabecalho">
            <h3 id="modalToggleAdminTitulo">👑 Alterar Permissões</h3>
            <span class="modal-confirmacao-fechar" onclick="fecharModalToggleAdmin()">&times;</span>
        </div>
        <div class="modal-confirmacao-corpo">
            <p id="modalToggleAdminMensagem">Tem certeza que deseja alterar as permissões deste usuário?</p>
            <p><strong>Esta ação afetará o acesso ao painel administrativo.</strong></p>
        </div>
        <div class="modal-confirmacao-rodape">
            <button class="btn-modal" onclick="fecharModalToggleAdmin()">
                <i class="fas fa-times"></i> Cancelar
            </button>
            <button class="btn-modal" onclick="confirmarToggleAdmin()">
                <i class="fas fa-check"></i> Sim, Confirmar
            </button>
        </div>
    </div>
</div>

<script>
    // 👇 VARIÁVEIS GLOBAIS
    let usuarioIdParaExcluir = null;
    let usuarioNomeParaExcluir = null;

    // 👇 VARIÁVEIS GLOBAIS PARA TOGGLE ADMIN
    let usuarioIdParaToggleAdmin = null;
    let isAdminParaToggle = null;
    let usuarioNomeParaToggle = null;

    // 👇 FUNÇÃO PARA FILTRAR USUÁRIOS
    function filtrarUsuarios() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const rows = document.querySelectorAll('.usuario-row');

        rows.forEach(row => {
            const username = row.cells[1].textContent.toLowerCase();
            const email = row.cells[2].textContent.toLowerCase();

            if (username.includes(searchTerm) || email.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    // 👇 ABRIR MODAL DE EXCLUSÃO
    function abrirModalExclusaoUsuario(id, username) {
        usuarioIdParaExcluir = id;
        usuarioNomeParaExcluir = username;

        document.getElementById('nome-usuario-excluir').textContent = username;
        document.getElementById('modalExclusaoUsuario').style.display = 'block';
    }

    // 👇 FECHAR MODAL
    function fecharModalUsuario() {
        document.getElementById('modalExclusaoUsuario').style.display = 'none';
        usuarioIdParaExcluir = null;
        usuarioNomeParaExcluir = null;
    }

    // 👇 CONFIRMAR EXCLUSÃO
    function confirmarExclusaoUsuario() {
        if (usuarioIdParaExcluir) {
            // Cria um formulário temporário para enviar a requisição POST
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/admin/usuario/${usuarioIdParaExcluir}/excluir`;

            // Adiciona o formulário à página e envia
            document.body.appendChild(form);
            form.submit();
        }
        fecharModalUsuario();
    }

    // 👇 ABRIR MODAL PARA TOGGLE ADMIN
    function abrirModalToggleAdmin(userId, username, isAdmin) {
        usuarioIdParaToggleAdmin = userId;
        usuarioNomeParaToggle = username;
        isAdminParaToggle = isAdmin;

        const titulo = isAdmin ? 'Remover Administrador' : 'Tornar Administrador';
        const mensagem = isAdmin ?
            `Tem certeza que deseja remover <strong>${username}</strong> dos administradores?` :
            `Tem certeza que deseja tornar <strong>${username}</strong> um administrador?`;

        document.getElementById('modalToggleAdminTitulo').textContent = titulo;
        document.getElementById('modalToggleAdminMensagem').innerHTML = mensagem;
        document.getElementById('modalToggleAdmin').style.display = 'block';
    }

    // 👇 FECHAR MODAL TOGGLE ADMIN
    function fecharModalToggleAdmin() {
        document.getElementById('modalToggleAdmin').style.display = 'none';
        usuarioIdParaToggleAdmin = null;
        usuarioNomeParaToggle = null;
        isAdminParaToggle = null;
    }

    // 👇 CONFIRMAR TOGGLE ADMIN - AGORA COM FLASH MESSAGE
    function confirmarToggleAdmin() {
        if (usuarioIdParaToggleAdmin !== null) {
            fetch('/admin/usuario/' + usuarioIdParaToggleAdmin + '/admin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ is_admin: isAdminParaToggle ? 0 : 1 })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 🔽 AGORA USA FLASH MESSAGE EM VEZ DE NOTIFICAÇÃO TEMPORÁRIA
                        // A mensagem será exibida através do Flask após o reload
                        window.location.href = '/admin/usuarios';
                    } else {
                        alert('Erro ao atualizar permissões: ' + data.message);
                    }
                })
                .catch(error => {
                    alert('Erro ao atualizar permissões');
                    console.error('Error:', error);
                });
        }
        fecharModalToggleAdmin();
    }

    // 👇 BUSCA EM TEMPO REAL
    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('searchInput');

        if (searchInput) {
            let searchTimeout;

            searchInput.addEventListener('input', function () {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    filtrarUsuarios();
                }, 300);
            });
        }

        // Fechar modal ao clicar fora
        document.getElementById('modalExclusaoUsuario').addEventListener('click', function (e) {
            if (e.target === this) {
                fecharModalUsuario();
            }
        });

        // Fechar modal toggle admin ao clicar fora
        document.getElementById('modalToggleAdmin').addEventListener('click', function (e) {
            if (e.target === this) {
                fecharModalToggleAdmin();
            }
        });
    });
</script>

<style>
    .search-bar {
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
    }

    .search-bar input {
        flex: 1;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
    }

    .usuarios-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .usuarios-table th,
    .usuarios-table td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }

    .usuarios-table th {
        background: linear-gradient(135deg, #ff6b8b, #ff4d73);
        color: white;
        font-weight: bold;
    }

    .usuarios-table tr:hover {
        background: #f8f9fa;
    }

    .admin-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: bold;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .badge-admin {
        background: #ff6b8b;
        color: white;
    }

    .badge-user {
        background: #3498db;
        color: white;
    }

    .badge-master {
        background: linear-gradient(135deg, #ff6b8b, #ff4d73);
        color: white;
        border: 2px solid gold;
    }

    .btn-admin {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 8px 12px;
        border-radius: 20px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        font-size: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .btn-admin:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .btn-admin:disabled:hover {
        transform: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .btn-danger {
        background: linear-gradient(135deg, #e74c3c, #c0392b) !important;
        color: white !important;
    }

    .btn-danger:hover {
        background: linear-gradient(135deg, #c0392b, #a93226) !important;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4) !important;
    }

    .btn-success {
        background: linear-gradient(135deg, #27ae60, #219653) !important;
        color: white !important;
    }

    .btn-success:hover {
        background: linear-gradient(135deg, #219653, #1e8449) !important;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4) !important;
    }

    .btn-primary {
        background: linear-gradient(135deg, #ff6b8b, #ff4d73) !important;
        color: white !important;
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #ff4d73, #9b59b6) !important;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 107, 139, 0.4) !important;
    }

    /* Estilos para modais */
    .modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
    }

    .modal-content {
        background: white;
        margin: 10% auto;
        padding: 0;
        border-radius: 15px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
        background: linear-gradient(135deg, #ff6b8b, #ff4d73);
        color: white;
        padding: 20px;
        border-radius: 15px 15px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 1.4em;
    }

    .modal-close {
        font-size: 1.8em;
        cursor: pointer;
    }

    .modal-body {
        padding: 30px;
        text-align: center;
    }

    .modal-footer {
        padding: 20px;
        text-align: center;
        border-top: 1px solid #eee;
        display: flex;
        gap: 15px;
        justify-content: center;
    }

    @media (max-width: 768px) {
        .usuarios-table {
            font-size: 14px;
        }

        .admin-badge {
            padding: 4px 8px;
            font-size: 12px;
        }
    }

    .badge-completo {
        background: #d4edda;
        color: #155724;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .badge-incompleto {
        background: #f8d7da;
        color: #721c24;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    /* Estilos para modais de confirmação - PADRONIZADO */
    .modal-confirmacao {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
    }

    .modal-confirmacao-conteudo {
        background: white;
        margin: 10% auto;
        padding: 0;
        border-radius: 15px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        overflow: hidden;
    }

    .modal-confirmacao-cabecalho {
        background: linear-gradient(135deg, #ff6b8b, #ff4d73);
        color: white;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-confirmacao-cabecalho h3 {
        margin: 0;
        font-size: 1.4em;
    }

    .modal-confirmacao-fechar {
        font-size: 1.8em;
        cursor: pointer;
    }

    .modal-confirmacao-corpo {
        padding: 30px;
        text-align: center;
    }

    .modal-confirmacao-rodape {
        padding: 20px;
        text-align: center;
        border-top: 1px solid #eee;
        display: flex;
        gap: 15px;
        justify-content: center;
    }

    .btn-modal {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 12px 25px;
        border-radius: 25px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        font-size: 16px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        background: linear-gradient(135deg, #ff6b8b, #ff4d73);
        color: white;
    }

    .btn-modal:hover {
        background: linear-gradient(135deg, #ff4d73, #9b59b6);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 107, 139, 0.4);
    }

    /* 🔽 CORREÇÃO: BOTÃO CANCELAR ROSA NO MODAL DE EXCLUSÃO */
    .modal-footer .btn-primary {
        background: linear-gradient(135deg, #ff6b8b, #ff4d73);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
    }

    .modal-footer .btn-primary:hover {
        background: linear-gradient(135deg, #ff4d73, #9b59b6);
        transform: translateY(-2px);
    }
</style>
{% endblock %}